{"version":3,"sources":["Blur.tsx"],"names":["vertShader","fragShader","Blur","setProcessing","processingState","imageData","setImageData","imageDataState","setEditingMode","editingModeState","glContext","setGLContext","glContextState","imageBounds","imageBoundsState","throttleBlur","React","useContext","EditorContext","sliderValue","setSliderValue","useState","blur","setBlur","glProgram","setGLProgram","onClose","onSaveWithBlur","gl","drawArrays","TRIANGLES","output","GLView","takeSnapshotAsync","Platform","OS","fileReaderInstance","FileReader","readAsDataURL","uri","onload","base64data","result","flippedOutput","ImageManinpulator","manipulateAsync","flip","FlipType","Vertical","width","height","setTimeout","useEffect","setupGL","asset","localUri","FileSystem","copyAsync","from","to","cacheDirectory","Asset","fromURI","downloadAsync","vert","createShader","VERTEX_SHADER","frag","FRAGMENT_SHADER","shaderSource","compileShader","program","createProgram","attachShader","linkProgram","useProgram","buffer","createBuffer","bindBuffer","ARRAY_BUFFER","verts","Float32Array","bufferData","STATIC_DRAW","positionAttrib","getAttribLocation","enableVertexAttribArray","vertexAttribPointer","FLOAT","texture","createTexture","activeTexture","TEXTURE0","bindTexture","TEXTURE_2D","texParameteri","TEXTURE_MAG_FILTER","LINEAR","TEXTURE_MIN_FILTER","texImage2D","RGBA","UNSIGNED_BYTE","uniform1i","getUniformLocation","uniform1f","pixelFrequency","Math","max","round","catch","e","console","error","firstPassTexture","TEXTURE1","drawingBufferWidth","drawingBufferHeight","fb","createFramebuffer","bindFramebuffer","FRAMEBUFFER","attachmentPoint","COLOR_ATTACHMENT0","framebufferTexture2D","endFrameEXP","throttleSliderBlur","useRef","value","leading","current","styles","container","row","justifyContent","slider","sliderTrack","prompt","StyleSheet","create","flex","flexDirection","alignItems","color","fontSize","textAlign","paddingHorizontal","maxWidth","borderRadius"],"mappings":"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","sourcesContent":["import * as React from \"react\";\nimport { StyleSheet, View, Text, PixelRatio, Platform } from \"react-native\";\nimport { useRecoilState } from \"recoil\";\nimport { IconButton } from \"../components/IconButton\";\nimport {\n  editingModeState,\n  glContextState,\n  glProgramState,\n  imageBoundsState,\n  imageDataState,\n  processingState,\n} from \"../Store\";\nimport { Slider } from \"@miblanchard/react-native-slider\";\nimport { Asset } from \"expo-asset\";\nimport { GLView } from \"expo-gl\";\nimport * as ImageManinpulator from \"expo-image-manipulator\";\nimport * as FileSystem from \"expo-file-system\";\nimport _, { debounce, throttle } from \"lodash\";\nimport { EditorContext } from \"../index\";\n\nconst vertShader = `\nprecision highp float;\nattribute vec2 position;\nvarying vec2 uv;\nvoid main () {\n  uv = position;\n  gl_Position = vec4(1.0 - 2.0 * uv, 0, 1);\n}`;\n\nconst fragShader = `\nprecision highp float;\nprecision highp int;\nuniform sampler2D texture;\nuniform highp float width;\nuniform highp float height;\nvarying vec2 uv;\nuniform highp int radius;\nuniform highp int pass;\nuniform highp float pixelFrequency;\nfloat gauss (float sigma, float x) {\n  float g = (1.0/sqrt(2.0*3.142*sigma*sigma))*exp(-0.5*(x*x)/(sigma*sigma));\n  return g;\n}\nvoid main () {\n  float f_radius = float(radius);\n  float sigma = (0.5 * f_radius);\n  // Get the color of the fragment pixel\n  vec4 color = texture2D(texture, vec2(uv.x, uv.y));\n  color *= gauss(sigma, 0.0);\n  // Loop over the neightbouring pixels\n  for (int i = -30; i <= 30; i++) {\n    // Make sure we don't include the main pixel which we already sampled!\n    if (i != 0) {\n      // Check we are on an index that doesn't exceed the blur radius specified\n      if (i >= -radius && i <= radius) {\n        float index = float(i);\n        // Caclulate the current pixel index\n        float pixelIndex = 0.0;\n        if (pass == 0) {\n          pixelIndex = (uv.y) * height;\n        }\n        else {\n          pixelIndex = uv.x * width;\n        }\n        // Get the neighbouring pixel index\n        float offset = index * pixelFrequency;\n        pixelIndex += offset;\n        // Normalise the new index back into the 0.0 to 1.0 range\n        if (pass == 0) {\n          pixelIndex /= height;\n        }\n        else {\n          pixelIndex /= width;\n        }\n        // Pad the UV \n        if (pixelIndex < 0.0) {\n          pixelIndex = 0.0;\n        }\n        if (pixelIndex > 1.0) {\n          pixelIndex = 1.0;\n        }\n        // Get gaussian amplitude\n        float g = gauss(sigma, index);\n        // Get the color of neighbouring pixel\n        vec4 previousColor = vec4(0.0, 0.0, 0.0, 0.0);\n        if (pass == 0) {\n          previousColor = texture2D(texture, vec2(uv.x, pixelIndex)) * g;\n        }\n        else {\n          previousColor = texture2D(texture, vec2(pixelIndex, uv.y)) * g;\n        }\n        color += previousColor;\n      }\n    }\n  }\n  // Return the resulting color\n  gl_FragColor = color;\n}`;\n\nexport function Blur() {\n  //\n  const [, setProcessing] = useRecoilState(processingState);\n  const [imageData, setImageData] = useRecoilState(imageDataState);\n  const [, setEditingMode] = useRecoilState(editingModeState);\n  const [glContext, setGLContext] = useRecoilState(glContextState);\n  const [imageBounds] = useRecoilState(imageBoundsState);\n  const { throttleBlur } = React.useContext(EditorContext);\n\n  const [sliderValue, setSliderValue] = React.useState(15);\n  const [blur, setBlur] = React.useState(15);\n  const [glProgram, setGLProgram] = React.useState<WebGLProgram | null>(null);\n\n  const onClose = () => {\n    // If closing reset the image back to its original\n    setGLContext(null);\n    setEditingMode(\"operation-select\");\n  };\n\n  const onSaveWithBlur = async () => {\n    // Set the processing to true so no UI can be interacted with\n    setProcessing(true);\n    // Take a snapshot of the GLView's current framebuffer and set that as the new image data\n    const gl = glContext;\n    if (gl) {\n      gl.drawArrays(gl.TRIANGLES, 0, 6);\n      const output = await GLView.takeSnapshotAsync(gl);\n      // Do any addtional platform processing of the result and set it as the\n      // new image data\n      if (Platform.OS === \"web\") {\n        const fileReaderInstance = new FileReader();\n        fileReaderInstance.readAsDataURL(output.uri as any);\n        fileReaderInstance.onload = async () => {\n          const base64data = fileReaderInstance.result;\n          const flippedOutput = await ImageManinpulator.manipulateAsync(\n            base64data as string,\n            [{ flip: ImageManinpulator.FlipType.Vertical }]\n          );\n          setImageData({\n            uri: flippedOutput.uri,\n            width: flippedOutput.width,\n            height: flippedOutput.height,\n          });\n        };\n      } else {\n        const flippedOutput = await ImageManinpulator.manipulateAsync(\n          output.uri as string,\n          [{ flip: ImageManinpulator.FlipType.Vertical }]\n        );\n        setImageData({\n          uri: flippedOutput.uri as string,\n          width: flippedOutput.width,\n          height: flippedOutput.height,\n        });\n      }\n\n      // Reset back to operation selection mode\n      setProcessing(false);\n      setGLContext(null);\n      // Small timeout so it can set processing state to flase BEFORE\n      // Blur component is unmounted...\n      setTimeout(() => {\n        setEditingMode(\"operation-select\");\n      }, 100);\n    }\n  };\n\n  React.useEffect(() => {\n    if (glContext !== null) {\n      const setupGL = async () => {\n        // Load in the asset and get its height and width\n        const gl = glContext;\n        // Do some magic instead of using asset.download async as this tries to\n        // redownload the file:// uri on android and iOS\n        let asset;\n        if (Platform.OS !== \"web\") {\n          asset = {\n            uri: imageData.uri,\n            localUri: imageData.uri,\n            height: imageData.height,\n            width: imageData.width,\n          };\n          await FileSystem.copyAsync({\n            from: asset.uri,\n            to: FileSystem.cacheDirectory + \"blur.jpg\",\n          });\n          asset.localUri = FileSystem.cacheDirectory + \"blur.jpg\";\n        } else {\n          asset = Asset.fromURI(imageData.uri);\n          await asset.downloadAsync();\n        }\n        if (asset.width && asset.height) {\n          // Setup the shaders for our GL context so it draws from texImage2D\n          const vert = gl.createShader(gl.VERTEX_SHADER);\n          const frag = gl.createShader(gl.FRAGMENT_SHADER);\n          if (vert && frag) {\n            // Set the source of the shaders and compile them\n            gl.shaderSource(vert, vertShader);\n            gl.compileShader(vert);\n            gl.shaderSource(frag, fragShader);\n            gl.compileShader(frag);\n            // Create a WebGL program so we can link the shaders together\n            const program = gl.createProgram();\n            if (program) {\n              // Attach both the vertex and frag shader to the program\n              gl.attachShader(program, vert);\n              gl.attachShader(program, frag);\n              // Link the program - ensures that vetex and frag shaders are compatible\n              // with each other\n              gl.linkProgram(program);\n              // Tell GL we ant to now use this program\n              gl.useProgram(program);\n              // Create a buffer on the GPU and assign its type as array buffer\n              const buffer = gl.createBuffer();\n              gl.bindBuffer(gl.ARRAY_BUFFER, buffer);\n              // Create the verticies for WebGL to form triangles on the screen\n              // using the vertex shader which forms a square or rectangle in this case\n              const verts = new Float32Array([\n                -1, -1, 1, -1, 1, 1, -1, -1, -1, 1, 1, 1,\n              ]);\n              // Actually pass the verticies into the buffer and tell WebGL this is static\n              // for optimisations\n              gl.bufferData(gl.ARRAY_BUFFER, verts, gl.STATIC_DRAW);\n              // Get the index in memory for the position attribute defined in the\n              // vertex shader\n              const positionAttrib = gl.getAttribLocation(program, \"position\");\n              gl.enableVertexAttribArray(positionAttrib); // Enable it i guess\n              // Tell the vertex shader how to process this attribute buffer\n              gl.vertexAttribPointer(positionAttrib, 2, gl.FLOAT, false, 0, 0);\n              // Fetch an expo asset which can passed in as the source for the\n              // texImage2D\n\n              // Create some space in memory for a texture\n              const texture = gl.createTexture();\n              // Set the active texture to the texture 0 binding (0-30)\n              gl.activeTexture(gl.TEXTURE0);\n              // Bind the texture to WebGL stating what type of texture it is\n              gl.bindTexture(gl.TEXTURE_2D, texture);\n              // Set some parameters for the texture\n              gl.texParameteri(gl.TEXTURE_2D, gl.TEXTURE_MAG_FILTER, gl.LINEAR);\n              gl.texParameteri(gl.TEXTURE_2D, gl.TEXTURE_MIN_FILTER, gl.LINEAR);\n              // Then set the data of this texture using texImage2D\n              gl.texImage2D(\n                gl.TEXTURE_2D,\n                0,\n                gl.RGBA,\n                gl.RGBA,\n                gl.UNSIGNED_BYTE,\n                asset as any\n              );\n              // Set a bunch of uniforms we want to pass into our fragment shader\n              gl.uniform1i(gl.getUniformLocation(program, \"texture\"), 0);\n              gl.uniform1f(\n                gl.getUniformLocation(program, \"width\"),\n                asset.width\n              );\n              gl.uniform1f(\n                gl.getUniformLocation(program, \"height\"),\n                asset.height\n              );\n              // Calculate the pixel frequency to sample at based on the image resolution\n              // as the blur radius is in dp\n              const pixelFrequency = Math.max(\n                Math.round(imageData.width / imageBounds.width / 2),\n                1\n              );\n              gl.uniform1f(\n                gl.getUniformLocation(program, \"pixelFrequency\"),\n                pixelFrequency\n              );\n              setGLProgram(program);\n            }\n          }\n        }\n      };\n      setupGL().catch((e) => console.error(e));\n    }\n  }, [glContext, imageData]);\n\n  React.useEffect(() => {\n    const gl = glContext;\n    const program = glProgram;\n    if (gl !== null && program !== null) {\n      gl.uniform1i(gl.getUniformLocation(program, \"texture\"), 0);\n      gl.uniform1i(gl.getUniformLocation(program, \"radius\"), blur);\n      gl.uniform1i(gl.getUniformLocation(program, \"pass\"), 0);\n      // Setup so first pass renders to a texture rather than to canvas\n      // Create and bind the framebuffer\n      const firstPassTexture = gl.createTexture();\n      // Set the active texture to the texture 0 binding (0-30)\n      gl.activeTexture(gl.TEXTURE1);\n      // Bind the texture to WebGL stating what type of texture it is\n      gl.bindTexture(gl.TEXTURE_2D, firstPassTexture);\n      // Set some parameters for the texture\n      gl.texParameteri(gl.TEXTURE_2D, gl.TEXTURE_MAG_FILTER, gl.LINEAR);\n      gl.texParameteri(gl.TEXTURE_2D, gl.TEXTURE_MIN_FILTER, gl.LINEAR);\n      // Then set the data of this texture using texImage2D\n      gl.texImage2D(\n        gl.TEXTURE_2D,\n        0,\n        gl.RGBA,\n        gl.drawingBufferWidth,\n        gl.drawingBufferHeight,\n        0,\n        gl.RGBA,\n        gl.UNSIGNED_BYTE,\n        null\n      );\n      const fb = gl.createFramebuffer();\n      gl.bindFramebuffer(gl.FRAMEBUFFER, fb);\n      // attach the texture as the first color attachment\n      const attachmentPoint = gl.COLOR_ATTACHMENT0;\n      gl.framebufferTexture2D(\n        gl.FRAMEBUFFER,\n        attachmentPoint,\n        gl.TEXTURE_2D,\n        firstPassTexture,\n        0\n      );\n      //gl.viewport(0, 0, imageData.width, imageData.height);\n      // Actually draw using the shader program we setup!\n      gl.drawArrays(gl.TRIANGLES, 0, 6);\n      gl.bindFramebuffer(gl.FRAMEBUFFER, null);\n      //gl.viewport(0, 0, imageData.width, imageData.height);\n      gl.uniform1i(gl.getUniformLocation(program, \"texture\"), 1);\n      gl.uniform1i(gl.getUniformLocation(program, \"pass\"), 1);\n      gl.drawArrays(gl.TRIANGLES, 0, 6);\n      gl.endFrameEXP();\n    }\n  }, [blur, glContext, glProgram]);\n\n  const throttleSliderBlur = React.useRef<(value: number) => void>(\n    throttle((value) => setBlur(value), 50, { leading: true })\n  ).current;\n\n  React.useEffect(() => {\n    return () => {};\n  });\n\n  if (glContext === null) {\n    return null;\n  }\n\n  return (\n    <View style={styles.container}>\n      <View style={[styles.row, { justifyContent: \"center\" }]}>\n        <Slider\n          value={sliderValue}\n          onValueChange={(value) => {\n            setSliderValue(value[0]);\n            if (throttleBlur) {\n              throttleSliderBlur(Math.round(value[0]));\n            } else {\n              setBlur(Math.round(value[0]));\n            }\n          }}\n          minimumValue={1}\n          maximumValue={30}\n          minimumTrackTintColor=\"#00A3FF\"\n          maximumTrackTintColor=\"#ccc\"\n          thumbTintColor=\"#c4c4c4\"\n          containerStyle={styles.slider}\n          trackStyle={styles.sliderTrack}\n        />\n      </View>\n      <View style={styles.row}>\n        <IconButton iconID=\"close\" text=\"Cancel\" onPress={() => onClose()} />\n        <Text style={styles.prompt}>\n          Blur Radius: {Math.round(sliderValue)}\n        </Text>\n        <IconButton\n          iconID=\"check\"\n          text=\"Done\"\n          onPress={() => onSaveWithBlur()}\n        />\n      </View>\n    </View>\n  );\n}\n\nconst styles = StyleSheet.create({\n  container: {\n    flex: 1,\n    flexDirection: \"column\",\n    justifyContent: \"space-between\",\n    alignItems: \"center\",\n  },\n  prompt: {\n    color: \"#fff\",\n    fontSize: 21,\n    textAlign: \"center\",\n  },\n  row: {\n    width: \"100%\",\n    height: 80,\n    flexDirection: \"row\",\n    justifyContent: \"space-between\",\n    alignItems: \"center\",\n    paddingHorizontal: \"2%\",\n  },\n  slider: {\n    height: 20,\n    width: \"90%\",\n    maxWidth: 600,\n  },\n  sliderTrack: {\n    borderRadius: 10,\n  },\n});\n"]}