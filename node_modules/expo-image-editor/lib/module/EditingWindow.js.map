{"version":3,"sources":["EditingWindow.tsx"],"names":["React","Image","StyleSheet","View","ImageCropOverlay","useRecoilState","imageDataState","imageBoundsState","imageScaleFactorState","editingModeState","glContextState","GLView","EditingWindow","imageLayout","setImageLayout","useState","imageData","setImageBounds","setImageScaleFactor","editingMode","setGLContext","isCropping","isBlurring","usesGL","getImageFrame","layout","onUpdateCropLayout","editingWindowAspectRatio","height","width","imageAspectRatio","bounds","x","y","imageScaleFactor","getGLLayout","windowHeight","windowWidth","windowAspectRatio","imageHeight","imageWidth","useEffect","onGLContextCreate","gl","styles","container","glContainer","backgroundColor","transform","scaleY","image","uri","nativeEvent","create","flex","resizeMode","justifyContent","alignItems"],"mappings":"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","sourcesContent":["import * as React from \"react\";\nimport { Image, PixelRatio, StyleSheet, View } from \"react-native\";\nimport { ImageCropOverlay } from \"./ImageCropOverlay\";\nimport { useRecoilState } from \"recoil\";\nimport {\n  imageDataState,\n  imageBoundsState,\n  imageScaleFactorState,\n  editingModeState,\n  glContextState,\n} from \"./Store\";\nimport { ExpoWebGLRenderingContext, GLView } from \"expo-gl\";\n\ntype ImageLayout = {\n  height: number;\n  width: number;\n} | null;\n\nfunction EditingWindow() {\n  //\n  const [imageLayout, setImageLayout] = React.useState<ImageLayout>(null);\n\n  const [imageData] = useRecoilState(imageDataState);\n  const [, setImageBounds] = useRecoilState(imageBoundsState);\n  const [, setImageScaleFactor] = useRecoilState(imageScaleFactorState);\n  const [editingMode] = useRecoilState(editingModeState);\n  const [, setGLContext] = useRecoilState(glContextState);\n\n  // Get some readable boolean states\n  const isCropping = editingMode === \"crop\";\n  const isBlurring = editingMode === \"blur\";\n  const usesGL = isBlurring;\n\n  const getImageFrame = (layout: {\n    width: number;\n    height: number;\n    [key: string]: any;\n  }) => {\n    onUpdateCropLayout(layout);\n  };\n\n  const onUpdateCropLayout = (layout: ImageLayout) => {\n    // Check layout is not null\n    if (layout) {\n      // Find the start point of the photo on the screen and its\n      // width / height from there\n      const editingWindowAspectRatio = layout.height / layout.width;\n      //\n      const imageAspectRatio = imageData.height / imageData.width;\n      let bounds = { x: 0, y: 0, width: 0, height: 0 };\n      let imageScaleFactor = 1;\n      // Check which is larger\n      if (imageAspectRatio > editingWindowAspectRatio) {\n        // Then x is non-zero, y is zero; calculate x...\n        bounds.x =\n          (((imageAspectRatio - editingWindowAspectRatio) / imageAspectRatio) *\n            layout.width) /\n          2;\n        bounds.width = layout.height / imageAspectRatio;\n        bounds.height = layout.height;\n        imageScaleFactor = imageData.height / layout.height;\n      } else {\n        // Then y is non-zero, x is zero; calculate y...\n        bounds.y =\n          (((1 / imageAspectRatio - 1 / editingWindowAspectRatio) /\n            (1 / imageAspectRatio)) *\n            layout.height) /\n          2;\n        bounds.width = layout.width;\n        bounds.height = layout.width * imageAspectRatio;\n        imageScaleFactor = imageData.width / layout.width;\n      }\n      setImageBounds(bounds);\n      setImageScaleFactor(imageScaleFactor);\n      setImageLayout({\n        height: layout.height,\n        width: layout.width,\n      });\n    }\n  };\n\n  const getGLLayout = () => {\n    if (imageLayout) {\n      const { height: windowHeight, width: windowWidth } = imageLayout;\n      const windowAspectRatio = windowWidth / windowHeight;\n      const { height: imageHeight, width: imageWidth } = imageData;\n      const imageAspectRatio = imageWidth / imageHeight;\n      // If the window is taller than img...\n      if (windowAspectRatio < imageAspectRatio) {\n        return { width: windowWidth, height: windowWidth / imageAspectRatio };\n      } else {\n        return { height: windowHeight, width: windowHeight * imageAspectRatio };\n      }\n    }\n  };\n\n  React.useEffect(() => {\n    onUpdateCropLayout(imageLayout);\n  }, [imageData]);\n\n  const onGLContextCreate = async (gl: ExpoWebGLRenderingContext) => {\n    setGLContext(gl);\n  };\n\n  return (\n    <View style={styles.container}>\n      {usesGL ? (\n        <View style={styles.glContainer}>\n          <GLView\n            style={[\n              {\n                height: 1,\n                width: 1,\n                backgroundColor: \"#ccc\",\n                transform: [{ scaleY: -1 }],\n              },\n              getGLLayout(),\n            ]}\n            onContextCreate={onGLContextCreate}\n          />\n        </View>\n      ) : (\n        <Image\n          style={styles.image}\n          source={{ uri: imageData.uri }}\n          onLayout={({ nativeEvent }) => getImageFrame(nativeEvent.layout)}\n        />\n      )}\n      {isCropping && imageLayout != null ? <ImageCropOverlay /> : null}\n    </View>\n  );\n}\n\nexport { EditingWindow };\n\nconst styles = StyleSheet.create({\n  container: {\n    flex: 1,\n  },\n  image: {\n    flex: 1,\n    resizeMode: \"contain\",\n  },\n  glContainer: {\n    flex: 1,\n    justifyContent: \"center\",\n    alignItems: \"center\",\n  },\n});\n"]}